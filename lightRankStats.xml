<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Tuesday, November 15, 2022, 4:07 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "lightRankStats" generated by Plugin Wizard -->

<muclient>
<plugin
   name="lightRankStats"
   author="TrEz"
   id="d0cfe6b6d8067e5fd9048d9f"
   language="Lua"
   purpose="Get rank stats and output CSV format for discord bot"
   save_state="y"
   date_written="2022-11-15 16:06:19"
   requires="5.07"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Aliases  -->

<aliases>
	<alias
		script="getRanks"
		match="^getRanks$"
		enabled="y"
		ignore_case="y"
		regexp="y"
		sequence="100"
		>
	</alias>
   <alias
		script="setRankEnchanted"
		match="^setrankenchanted (.*?)$"
		enabled="y"
		ignore_case="y"
		regexp="y"
		sequence="100"
		>
	</alias>
</aliases>

<!--  Triggers  -->

<triggers>
	<trigger
		enabled="n"
      name="triggerRank10"
		group="rankTriggers"
		match="\s([a-zA-Z]+)\s+([a-zA-Z]+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+)\s*(\d*)$"
		sequence="100"
		ignore_case="y"
		omit_from_output="n"
		regexp="y"
		script="storeRank10Data"
		>
	</trigger>
   <trigger
		enabled="n"
      name="triggerRank18"
		group="rankTriggers"
		match="\s([a-zA-Z]+)\s+([a-zA-Z]+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+)\s*(\d*)$"
		sequence="100"
		ignore_case="y"
		omit_from_output="n"
		regexp="y"
		script="storeRank18Data"
		>
	</trigger>
   <trigger
		enabled="n"
      name="triggerRank16"
		group="rankTriggers"
		match="\s([a-zA-Z]+)\s+([a-zA-Z]+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+\.?\d+)\s+(\d+)\s*(\d*)$"
		sequence="100"
		ignore_case="y"
		omit_from_output="n"
		regexp="y"
		script="storeRank16Data"
		>
	</trigger>
   <trigger
		enabled="n"
      name="triggerRankGold"
		group="rankTriggers"
		match="^You have donated (.*?) gold and (.*?) qp to your clan\.$"
		sequence="100"
		ignore_case="y"
		omit_from_output="n"
		regexp="y"
		script="storeRankGoldData"
		>
	</trigger>
   <trigger
		enabled="n"
      name="triggerRankRooms"
		group="rankTriggers"
		match="^You have explored (.*?) \((.*?)\) rooms of Aardwolf\.$"
		sequence="100"
		ignore_case="y"
		omit_from_output="n"
		regexp="y"
		script="storeRankRoomsData"
		>
	</trigger>
   <trigger
		enabled="n"
      name="triggerRank10NotFound"
		group="rankTriggers"
		match="^You are not on the Warfare kills rankings.$"
		sequence="100"
		ignore_case="y"
		omit_from_output="n"
		regexp="y"
		script="skipRank10"
		>
	</trigger>
</triggers>

<script>
<![CDATA[

require "tprint"
require "serialize"
require "gmcphelper"

lightRankData = {
   qps = 0,
   gqs = 0,
   warWins = 0,
   warKills = 0,
   rooms = 0,
   cps = 0,
   pups = 0,
   mobs = 0,
   enchanted = 0,
   gold = 0,
   levels = 0
}

function getRanks()
   EnableTrigger("triggerRank10", 1)
   EnableTrigger("triggerRank10NotFound", 1)
   Execute("myrank 10")
end -- getRanks

function skipRank10()
   lightRankData["warWins"] = 0
   lightRankData["warKills"] = 0

   EnableTrigger("triggerRank18", 1)
   Execute("myrank 18")
   EnableTrigger('triggerRank10', 0)
   EnableTrigger("triggerRank10NotFound", 0)
end -- skipRank10

function storeRank10Data(name, line, wc)
   if(wc[1] == gmcp("char.base.name")) then
      lightRankData["warWins"] = wc[6]
      lightRankData["warKills"] = wc[7]

      EnableTrigger("triggerRank18", 1)
      Execute("myrank 18")
      EnableTrigger('triggerRank10', 0)
      EnableTrigger("triggerRank10NotFound", 0)
   end
end -- storeRank10Data

function storeRank18Data(name, line, wc)
   if(wc[1] == gmcp("char.base.name")) then
      lightRankData["levels"] = wc[3]
      lightRankData["qps"] = wc[4]
      lightRankData["mobs"] = wc[5]
      lightRankData["gqs"] = wc[7]
      lightRankData["cps"] = wc[8]

      EnableTrigger("triggerRank16", 1)
      Execute("myrank 16")
      EnableTrigger("triggerRank18", 0)
   end
end -- storeRank18Data

function storeRank16Data(name, line, wc)
   if(wc[1] == gmcp("char.base.name")) then
      lightRankData["pups"] = wc[7]

      EnableTrigger("triggerRankGold", 1)
      Execute("whois")
      EnableTrigger("triggerRank16", 0)
   end
end -- storeRank16Data

function storeRankGoldData(name, line, wc)
   lightRankData["gold"] = wc[1]
   EnableTrigger("triggerRankRoom", 1)
   

   EnableTrigger("triggerRankGold", 0)
end -- storeRankGoldData

function storeRankGoldData(name, line, wc)
   lightRankData["gold"] = wc[1]:gsub('[%p%c%s]', '')

   EnableTrigger("triggerRankRooms", 1)
   Execute("explored")
   
   EnableTrigger("triggerRankGold", 0)
end -- storeRankGoldData

function storeRankRoomsData(name, line, wc)
   lightRankData["rooms"] = wc[1]

   tprint(lightRankData)

   ColourNote("orange", "", "Rank info copied to Clipboard!")
   SetClipboard (string.format("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s", lightRankData["qps"],lightRankData["gqs"],lightRankData["levels"],lightRankData["warWins"],lightRankData["warKills"],lightRankData["rooms"],lightRankData["cps"],lightRankData["pups"],lightRankData["mobs"],lightRankData["enchanted"],lightRankData["gold"]))

   EnableTrigger("triggerRankRooms", 0)
   EnableGroup("rankTriggers", 0)
end -- storeRankRoomsData

function setRankEnchanted(name, line, wc)
   ColourNote("orange", "", string.format("Enchanted items: %s", wc[1]))
   lightRankData["enchanted"] = wc[1]
end -- setRankEnchanted

function OnPluginInstall ()
	assert (loadstring (GetVariable ("lightRankData") or "")) ()
end -- function OnPluginInstall

function OnPluginSaveState()
	SetVariable ("lightRankData", "lightRankData = " .. serialize.save_simple (lightRankData))
end -- OnPluginSaveState

]]>
</script>

</muclient>
